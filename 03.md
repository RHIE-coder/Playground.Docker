# :dart: 도커(Docker)

## :lock: 도커에 대한 이해

 - 쿠버네티스를 이루는 기본 오브젝트(Object)가 파드(Pod)
 - 파드는 컨테이너(Container)로 이루어져 있음
 - 컨테이너를 만들고 관리하는 도구가 도커

```
파드들은 워커 노드라는 워커 노드로 관리됨
워커노드와 마스터 노드가 모여 쿠버네티스 클러스터가 됨
파드는 1개 이상의 컨테이너로 이루어져 있음
파드는 쿠버네티스로부터 IP를 받아 컨테이너가 외부와 통신할 수 있는 경로 제공
컨테이너 정상 동작 확인 후 네트워크나 저장 공간 서로 공유
컨테이너들은 마치 하나의 호스트에 존재하는 것처럼 작동
돌보는 관계도 : 마스터 노드 -> 워커 노드 -> 파드 -> 컨테이너
```

### :key: 도커의 Containerd

 - Docker사에서 컨테이너 런타임 부분을 분리하여 만든 오픈소스 컨테이너 관리 도구
 - 쿠버네티스와의 통신에 필요한 CRI(Container Runtime Interface) 규격에 맞춰 구현한 플러그인을 사용해 쿠버네티스와 통합할 수 있음

## :lock: 도커 사용해보기

### :key: 이미지 검색 후 다운로드

#### - `docker search`로 이미지 검색

```bash
docker search nginx
```
#### - `docker pull`로 이미지 다운로드

```bash
docker pull nginx
```
```
dfj3fj29vawq : Pull complete # 레이어
fejgi642azdf : Pull complete # 레이어
Digest : sha256:~~~
```
 - 하나의 이미지는 여러 개의 레이어로 이루어져 있음
 - 다이제스트는 이미지의 고유 식별자임
 - 태그는 이름이 동일한 이미지에 추가하는 식별자로 버전이나 플랫폼(CPU, OS 등)을 구별하는데 사용

```bash
docker pull nginx:stable
```
```
stable: Pulling from library/nginx
b380bbd43752: Already exists
83acae5e2daa: Pull complete
33715b419f9b: Pull complete
eb08b4d557d8: Pull complete
74d5bdecd955: Pull complete
0820d7f25141: Pull complete
Digest: sha256:9e37120c97a0787656cad9c24c3a5d5d606a770523144d01eae6734095a92c20
Status: Downloaded newer image for nginx:stable
docker.io/library/nginx:stable
```

 - 도커 이미지는 압축 파일과 비슷하지만 다른 점이라면 동일한 레이어를 공유한다는 점이다.


#### - `docker images`, `docker history`

 - `docker images`

내려받은 이미지 조회

```bash
docker images nginx
```
```
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
nginx        stable    c8d03f6b8b91   3 weeks ago   133MB
nginx        latest    87a94228f133   3 weeks ago   133MB
```
다운로드한 총 이미지의 크기가 133MB + 133MB로 266으로 보이지만 공유한 레이어가 있다면 그보다 적을 수 있다.

 - `docker history`

이미지가 어떤 과정을 거쳐 생성되었는지 확인

 - nginx:latest

```bash
docker history nginx:latest
```
```
IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT
87a94228f133   3 weeks ago   /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon…   0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr…   0B
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:09a214a3e07c919a…   4.61kB
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7…   1.04kB
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:0b866ff3fc1ef5b0…   1.96kB
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:65504f71f5855ca0…   1.2kB
<missing>      3 weeks ago   /bin/sh -c set -x     && addgroup --system -…   64MB
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENV NJS_VERSION=0.6.2        0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.21.3     0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>      3 weeks ago   /bin/sh -c #(nop) ADD file:910392427fdf089bc…   69.3MB
```

 - nginx:stable

```bash
docker history nginx:stable
```
```
IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT
c8d03f6b8b91   3 weeks ago   /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon…   0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr…   0B
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:09a214a3e07c919a…   4.61kB
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7…   1.04kB
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:0b866ff3fc1ef5b0…   1.96kB
<missing>      3 weeks ago   /bin/sh -c #(nop) COPY file:65504f71f5855ca0…   1.2kB
<missing>      3 weeks ago   /bin/sh -c set -x     && addgroup --system -…   63.9MB
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENV NJS_VERSION=0.5.3        0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.20.1     0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B
<missing>      3 weeks ago   /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>      3 weeks ago   /bin/sh -c #(nop) ADD file:910392427fdf089bc…   
69.3MB
```

`ADD file:910392427fdf089bc…   69.3MB` 이부분의 레이어가 공유된다.

즉, 총 이미지 크기는 133MB + 133MB가 아니라 (133MB * 2) - 69.3MB로 196.7MB가 된다.

이처럼 도커는 여러 이미지를 받더라도 효율적으로 관리할 수 있다.

### :key: 컨테이너 사용하기

#### - `docker run`

```bash
docker run -d --restart always nginx
```

 - `-d, --detach` : 백그라운드에서 구동 
 - `--restart` : 컨테이너 재시작 정책

```
[옵션이름] : [비정상 종료 시]/[도커 서비스 시작 시]
no(default) : 컨테이너를 재시작X / 컨테이너 시작X
on-failure : 컨테이너 재시작O / 컨테이너 시작O
always : 컨테이너 재시작O / 컨테이너 시작O
unless-stopped : 컨테이너 재시작O / 사용자가 직접 정지하지 않은 컨테이너만 시작
```

#### - `docker ps`

컨테이너 상태 확인

```bash
docker ps
```

특정 컨테이너 확인

```bash
docker ps -f id=1c6
```

### :key: 컨테이너와 연결하기

현재 상태로는 가상 머신 호스트에서 컨테이너의 80번 포트에 접속할 수 없음

응답을 컨테이너에서 처리해주기를 원한다면 80번으로 들어온 것을 컨테이너에서 받아줄 수 있는 포트로 연결해 주는 설정이 추가로 필요

```bash
curl 127.0.0.1
```
```
curl: (7) Failed to connect to 127.0.0.1 port 80: 연결이 거부됨
```

컨테이너는 immutable infrastructure이므로 새로운 컨테이너를 생성해야 함

#### - `-p, --publish` 옵션을 사용

`<요청 받을 호스트 포트>:<연결할 컨테이너 포트>`

```bash
docker run -d -p 8080:80 --name nginx-exposed --restart always nginx
```

 - 조회 
```bash
docker ps -f name=nginx-exposed
```

 - 요청 보내보기
```
curl 127.0.0.1:8080
```
```html
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

### :key: 컨테이너와 연결하기
